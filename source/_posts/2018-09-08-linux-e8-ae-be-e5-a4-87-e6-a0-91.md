---
title: linux设备树
url: 1731.html
id: 1731
comments: false
categories:
  - I·TQ
tags:
  - linux
---

Device Tree是一种用来描述硬件的数据结构，类似板级描述语言，起源于OpenFirmware(OF)。在目前广泛使用的Linux kernel中对于不同平台、不同硬件往往存在着大量的不同的、移植性差的板级描述代码，以达到对这些不同平台和不同硬件特殊适配的需求。但是过多的平台、过的的不同硬件导致了这样的代码越来越多。 Device Tree的引入给驱动适配带来了很大的方便，一套完整的Device Tree可以将PCB组成描述给你：Device Tree可以描述CPU、时钟、中断控制器、IO控制器、SPI总线控制器、I2C控制器、存储设备等任何现有驱动单位。对具体器件能够描述到使用哪个中断，内存映射空间是多少等等。 Device Tree由节点和属性构成。属性为key-value对，节点包括了各种属性，也可以包含子节点。这个文件实际上没有任何意义，但却包含了基本所有要素： 1、唯一的根节点 “/”，每个完整的dts文件必须拥有一个根节点，dtsi文件一般为通用文件（类似C语言的头文件），可被其他文件include。 2、一些节点：node1 node2，节点名的命名规则一般是 \[name\]@\[address\]，也可以只有name而没有@之后的内容，但是要确保name不能重名。如果加了@以及地址，那么name可以相同，只要address不同即可；每一个设备节点都要有一个compatible属性，compatible的内容是用来匹配驱动的，组成方式为"\[manufacturer\], \[model\]"，加入厂商名是为了避免重名有的时候后边还会跟一个名字。 3、子节点 node1 的子节点 child-node1 和 child-node2。 4、一群分散的属性，属性都是简单的key-value对，其中value也可以是空的或包含任意的byte流。 设备的地址特性根据几个属性来控制： 1、reg，意为region，格式为：reg = <address1 length1 \[address2 length2\] \[address3 length3\]>; 2、#address-cells，address-cells决定了address1/2/3包含几个cell 3、#size-cells，size-cells决定了length1/2/3包含了几个cell 带有片选的节点信息描述： #address-cells = <2>; #size-cells = <1>; ethernet@0,0 { compatible = "smc,smc91c111"; reg = <0 0 0x1000>; #address-cells = <2> 表明使用两个cell来描述地址，一个是片选序号，另一个是片选序号上的偏移量，而地址空间长度依然用一个cell来描述。所以以上的子设备们都需要3个cell来描述地址空间属性——片选、偏移量、地址长度。 i2c@1,0 { compatible = "acme,a1234-i2c-bus"; #address-cells = <1>; #size-cells = <0>; reg = <1 0 0x1000>; rtc@58 { compatible = "maxim,ds1338"; reg = <58>; 因为I2C设备只是被分配在一个地址上不需要其他任何内存空间，所以只需要一个address的cell就可以描述完整，不需要size-cells。 当需要描述的设备不是本地设备时，就需要描述一个从设备地址空间到CPU地址空间的映射关系，ranges属性为一个地址转换表，表中的每一行都包含了子地址、父地址、在自地址空间内的区域大小。他们的大小（包含的cell）分别由子节点的address-cells的值、父节点的address-cells的值和子节点的size-cells来决定。 #address-cells = <1>; #size-cells = <1>; ... external-bus { #address-cells = <2>; #size-cells = <1>; ranges = < 0 0 0x10100000 0x10000 // Chipselect 1 1 0 0x10160000 0x10000 // Chipselect 2 2 0 0x30000000 0x1000000 // Chipselect 3 >;}; 其中0 0 两个cell，由子节点external-bus的address-cells=<2>决定；0x10100000 一个cell，由父节点的address-cells=<1>决定；0x10000 一个cell，由子节点external-bus的size-cells=<1>决定。最终第一行说明的意思就是：片选0，偏移0（选中了网卡），被映射到CPU地址空间的0x10100000~0x10110000中，地址长度为0x10000。