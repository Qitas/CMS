---
title: ESP存储及烧录
url: 1431.html
id: 1431
categories:
  - IT·Q
tags:
  - 编程
---

最近工作中遇到了ESP32的各种坑，当然能坑到我还是因为我太稚嫩了。 ESP32/8266启动过程： 1、芯片上电后会先运行片上固化的ROM，完成必要初始化及串口打印； 2、片上ROM读取SPI Flash 0x00000处的flash.bin，解析出text、data、rodata的位置，并将这3部分加载到片上内存中， 其中，text会加载到iram1上，因此text最大不能超过32KB(0x8000)； data和rodata会加载到dram0上，因此这二者和不能大于80KB(0x14000)；在dram0之上还有bbs、stack、heap，要注意使用量。以IoT\_Demo固件为例来看：data+rodata+bbs = 0x8574， 因此stack和heap能用的内存只有46K左右，空白固件大约还剩有50KB左右； 3、片上固化的rom加载flash.bin完毕，跳到入口entry\_addr执行； 4、当执行到irom1上的代码时(通过ICACHE\_FLASH\_ATTR定义的函数)，会将它们从SPI Flash上加载到cache中运行；所以注意不要在 GPIO 或 UART 中断处理函数中调用带有 "ICACHE\_FLASH\_ATTR" 宏的函数，否则将进入异常。 esp32/8266片上的ROM都几乎等于没有（不对用户开放使用），通过支持多种 cache 映射机制来将外部ROM数据读入，默认的使用的是1MB + 1MB 的映射机制，即将spi flash中的0x000000~0x1FFFFF 映射到 0x40200000 ~ 0x402FFFFF，0x100000 ~ 0x1FFFFF 映射到 0x40200000 ~ 0x402FFFFF。 iram1\_0\_seg 总共：64KB，包括 cache 32 KB（0x40108000）和 IRAM 32 KB（0x40100000），sdk 启动后会将对应的spi flash 空间映射到 cache空间。 针对4MB(32Mbit) SPI Flash（0x3F400000-0x3F800000），irom0text.bin默认最大为200KB；ESP8266目前程序最大支持1024 KB，因此对于4096 KB Flash，用户可修改编译的代码区最大支持到1024 - 256 = 768 KB。 由于片上固话的ROM我们不能更改，因此编写代码时必须要遵循FLASH MAP地址和大小限制。 总结一下ESP32，大家选择这颗芯片，除了双核不错的的主频和资源外，最大的理由就是WiFi+BT的双模无线通信了，可惜，折腾很久之后绝望的发现，WiFi和BT是无法共存于一份代码中的，所有的相关的代码都是分开编译，究其原因：DRAM不够和bin文件太大，明明是520K的SRAM，结果用官方的工程编译执行就看到250K左右的RAM大小，那位大神能够释放400K以上的RAM还请教教我~。