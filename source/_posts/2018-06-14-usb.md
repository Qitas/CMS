---
title: USB
url: 1487.html
id: 1487
categories:
  - I·TQ
tags:
  - 通信
---

**USB协议配置分析** **const u8 DeviceDescriptor\[SIZ\_DEVICE\_DESC\]** = { 0x12, /\*bLength描述符长度，固定为0x12\*/ USB\_DEVICE\_DESCRIPTOR\_TYPE, /\*bDescriptorType 固定为0x01\*/ 0x10, 0x01, /\*USB 规范发布号：USB1.1 \*/ 0x00, /*当它的值是0时，表示所有接口在配置描述符里，并且所有接口是独立的。当它值是1-FEH时，不同的接口关联的。当它的值是FFH时，厂商自己定义的*/ 0x00, /*子类型代码（由USB分配）一般设置为0．其它情况跟据USB-IF组织定义的编码*/ 0x00, /\*bDeviceProtocol: Interface Association Descriptor\*/ /*协议代码（由USB分配）．如果使用USB-IF组织定义的协议需要设置这里的值，否则直接设置为0。如果厂商自己定义的可以设置为FFH．*/ 0x40,  /\*bMaxPacketSize0: 端点０最大分组大小（只有8,16,32,64有效）．\*/ ID\_VENDOR\_L, ID\_VENDOR\_H, /\*idVendor 供应商ID（由USB分配），表示厂商代号\*/ ID\_PRODUCT\_L, ID\_PRODUCT_H, /\*idProduct = 0x5678该产品的编号，产品ID（由厂商分配）\*/ 0x00,0x01, /\*bcdDevice设备编码，由厂家自行设置 rel. 1.00 BCD码表示的设备版本号\*/ 1, /*厂商描述符字符串索引．索引到对应的字符串描述符． 为０则表示没有 */ 2, /*产品描述符字符串索引．同上*/ 3, /*设备序列号字符串索引．同上 */ 0x01 /*可能的配置数．指配置字符串的个数*/ }; **/\* DeviceDescriptor */** 每一个设备(device)会有一个或者多个的逻辑连接点在里面,每个连接点叫endpoint；每个endpoint有四种数据传送方式:控制(Control)/同步(isochronous)/中断(interrupt)/大量(bulk)；所有的endpoint0都被用来传送配置和控制信息。在host和设备的endpoint之间的连接叫作管道“pipe",endpoint0是缺省(default pipe)。 对于同样性质的一组的endpoint的组合叫做接口(interface),如果一个设备包含不止一个的接口就可以称之为复合设备(composite device)。对于同样类型的接口组合可以称之为配置(configuration)。每次只能有一个配置是可用的,而一旦该配置激活,里面的接口和endpoint就都同时可以使用。 **const u8 ConfigDescriptor\[SIZ\_CONFIG\_DESC\]** = { 0x09, /* bLength固定为0x09 */ USB\_CONFIGURATION\_DESCRIPTOR\_TYPE, /* bDescriptorType固定为0x02 */ SIZ\_CONFIG\_DESC, 0x00, /*返回整个数据的长度（2bytes），小端*/ 0x02, /\*bNumInterfaces:配置所支持的接口数．指该配置配备的接口数量，也表示该配置下接口描述符数量\*/ 0x01, /\*bConfigurationValue:作为Set Configuration的一个参数选择配置值\*/ 0x00, /\*iConfiguration: 用于描述该配置字符串描述符的索引\*/ 0xA0, /\*bmAttributes: 供电模式选择．Bit4-0保留，D7:总线供电，D6:自供电，D5:远程唤醒\*/ 0x64, /*总线供电的USB设备的最大消耗电流．以2mA为单位*/ /************** Descriptor of interface ****************/ 0x09, /\*bLength: 固定为0x09\*/ USB\_INTERFACE\_DESCRIPTOR\_TYPE,/\*bDescriptorType\*/ 0x00, /\*bInterfaceNumber: 接口的编号\*/ 0x00, /\*bAlternateSetting: 为上一个字段选择可供替换的位置．即备用的接口描述符标号\*/ 0x02, /\*bNumEndpoints使用的端点数目．端点０除外\*/ 0x03, /\*bInterfaceClass: HID 类型代码（由USB分配）\*/ 0x00, /\*bInterfaceSubClass 子类型代码（由USB分配）: 1=BOOT, 0=no boot\*/ 0x00, /\*nInterfaceProtocol协议代码（由USB分配） : 0=none, 1=keyboard, 2=mouse\*/ 0, /\*iInterface: 字符串描述符的索引\*/ /******************** Descriptor of HID ********************/ 0x09, /\*bLength: HID Descriptor size\*/ HID\_DESCRIPTOR\_TYPE, /\*bDescriptorType: HID\*/ 0x00, /\*bcdHID: HID Class Spec release number\*/ 0x01, 0x00, /\*bCountryCode: Hardware target country\*/ 0x01, /\*bNumDescriptors: Number of HID class descriptors to follow\*/ 0x22, /\*bDescriptorType\*/ SIZ\_REPORT\_DESC,/\*wItemLength: Total length of Report descriptor\*/ 0x00, /******************** Descriptor of endpoint ********************/ 0x07, /\*bLength: Endpoint Descriptor size 固定为0x07\*/ USB\_ENDPOINT\_DESCRIPTOR\_TYPE, /\*bDescriptorType:\*/ 0x81, /\*bEndpointAddress: Endpoint Address (IN)USB设备的端点地址．Bit7，方向，对于控制端点可以忽略，1/0:IN/OUT．Bit6-4，保留．BIt3-0：端点号\*/ 0x03, /\*bmAttributes: Interrupt endpoint 端点属性．Bit7-2，保留．BIt1-0：00控制，01同步，02批量，03中断\*/ REC\_BUFFER_SIZE, 0x00, /\*wMaxPacketSize: 64 Byte max 本端点接收或发送的最大信息包大小 \*/ 0x0A, /\*bInterval: Polling Interval (10 ms) 轮训数据传送端点的时间间隔． 对于同步传送的端点，必须为１ 对于中断传送的端点，范围为１－２５５\*/ }; **/\* ConfigDescriptor */**