---
title: C语言宏
---

在C语言编程中，通常通过宏定义来提高编程的效率，一些相关的知识整理如下： 1、宏名之后带括号的宏被认为是宏函数，宏函数的用法和普通函数一样，只不过在预处理阶段，宏函数会被展开。 宏函数的优点是没有普通函数保存寄存器和参数传递的开销，展开后的代码有利于CPU cache的利用和指令预测，速度快，对应的缺点是可执行代码体积变大。 2、定义的宏太长需要换行写时，一样需要在行末加反斜杠\\，同时需要注意语句的完整性和上下文相关性，由于宏是纯文本替换，预处理器不对宏体做任何语法检查，在宏体中，给引用的参数加个括号就能避免这问题，不要吝啬（）。 3、字符串化(Stringification)，在宏体中，如果宏参数前加个#，那么在宏体扩展的时候，宏参数会被扩展成字符串的形式，表示直接传递字符串。 4、连接(Concatenation)，在宏体中，如果宏体所在标示符中有##，那么在宏体扩展的时候，宏参数会被直接替换到标示符中，用于参数字符串连接。 5、大括号导致的问题，在Linux内核源码里很常见#define SET\_REG\_BIT(reg, bit) do { (reg |= (1 << (bit))); } while (0)，通过do ... while(0)的形式可以保证代码块的完整。 6、宏的递归，如果在宏中递归定义，如#define foo (4 + foo)，理论上会展开成(4 + (4 + foo))一直迭代下去，但实际的预处理器过程只展开一次，而展开之后foo的含义就要根据上下文来确定了。类似的宏交叉引用，也只会展开一次。